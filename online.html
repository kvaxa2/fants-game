<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåê –û–Ω–ª–∞–π–Ω-–∫–æ–º–Ω–∞—Ç–∞ ‚Äî –§–∞–Ω—Ç—ã –¥–ª—è –ø–∞—Ä</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // üîë –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ‚Äî –∫–æ–ø–∏—è –∏–∑ index.html
    const firebaseConfig = {
      apiKey: "AIzaSyDOF1Vxk4FPoDd5imnm3TdjtsQDjC8qmdI",
      authDomain: "fants-game.firebaseapp.com",
      databaseURL: "https://fants-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fants-game",
      storageBucket: "fants-game.firebasestorage.app",
      messagingSenderId: "143359324758",
      appId: "1:143359324758:web:4c7b69c4d091ce712f41f7",
      measurementId: "G-TKHG5KNRZP"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(45deg, #6750A4, #FF5252);
      color: white;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }
    .screen {
      display: none;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .active { display: block; }
    h1 { font-size: 2.2rem; margin-bottom: 1.5rem; text-align: center; }
    h2 { font-size: 1.6rem; margin: 1.5rem 0 1rem; text-align: center; }
    input, button {
      font-size: 1.1rem;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #444;
      background: #1e1e1e;
      color: #fff;
      width: 100%;
      margin: 8px 0;
    }
    button {
      background: #6750A4;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #333; }
    button.danger { background: #ba1a1a; }
    button[disabled] { opacity: 0.5; }
    .players-list {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
    }
    .player-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }
    .player-item:last-child { border-bottom: none; }
    .player-name { font-weight: bold; }
    .player-ready { color: #8bc34a; }
    .instructions {
      font-size: 0.9rem;
      color: #bbb;
      text-align: center;
      margin-top: 20px;
    }
    .room-code {
      font-size: 1.4rem;
      font-weight: bold;
      text-align: center;
      margin: 12px 0;
      letter-spacing: 4px;
      color: #fff;
      background: rgba(0,0,0,0.2);
      padding: 8px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <!-- üì± –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
  <div id="roomScreen" class="screen active">
    <h1>üåê –û–Ω–ª–∞–π–Ω-–∫–æ–º–Ω–∞—Ç–∞</h1>
    <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (AAAAAA)" maxlength="6" 
           style="text-transform: uppercase; letter-spacing: 2px;" autocomplete="off" />
    <div style="display: flex; gap: 8px;">
      <button id="joinRoomBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      <button id="createRoomBtn" class="secondary">üÜï –°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <p class="instructions">
      ‚Ä¢ –°–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ –∏ –¥–µ–ª–∏—Ç—Å—è –∏–º.<br>
      ‚Ä¢ –í—Å–µ 4 –∏–≥—Ä–æ–∫–∞ –∑–∞—Ö–æ–¥—è—Ç, –≤–≤–æ–¥—è—Ç –∏–º—è –∏ –∂–¥—É—Ç —Å—Ç–∞—Ä—Ç–∞.<br>
      ‚Ä¢ –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω ‚Äî –º–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å.
    </p>
    <button id="backToMainBtn" class="secondary" style="margin-top: 20px;">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
  </div>

  <!-- üìã –õ–æ–±–±–∏ -->
  <div id="lobbyScreen" class="screen">
    <h1>üë• –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</h1>
    <div class="room-code" id="lobbyRoomCode">‚Äî</div>
    <div class="players-list" id="playersList">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
    </div>
    <p id="readyStatus" style="text-align:center; color:#888;">–û–∂–∏–¥–∞—é—Ç—Å—è –∏–≥—Ä–æ–∫–∏...</p>
    <button id="startGameBtn" disabled>‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button id="leaveRoomBtn" class="secondary" style="margin-top: 12px;">üö™ –ü–æ–∫–∏–Ω—É—Ç—å</button>
  </div>

  <!-- ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ -->
  <div id="loadingScreen" class="screen">
    <h1>‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</h1>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
  </div>

  <!-- –î–∏–∞–ª–æ–≥: –≤–≤–æ–¥ –∏–º–µ–Ω–∏ -->
  <div id="nameDialog" class="screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#1e1e1e; padding:24px; border-radius:16px; max-width:400px; width:90%;">
      <h3>üë§ –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å</h3>
      <input type="text" id="playerNameInput" placeholder="–í–∞—à–µ –∏–º—è" maxlength="16" style="margin:8px 0;" />
      <div style="margin-top:16px; display:flex; gap:8px;">
        <button id="nameSubmitBtn" style="flex:1; background:#6750A4;">–í–æ–π—Ç–∏</button>
        <button id="nameCancelBtn" class="secondary" style="flex:1;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // üîß –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // ==========================
    let roomId = null;
    let playerId = null; // uid –∏–ª–∏ guest_XXXX
    let playerName = null;
    let roomRef = null;
    let playersRef = null;

    // ==========================
    // üß≠ –ü–û–ú–û–©–ù–ò–ö–ò
    // ==========================
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
      });
      const s = document.getElementById(id);
      if (s) {
        s.style.display = 'block';
        setTimeout(() => s.classList.add('active'), 10);
      }
    }

    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase().padEnd(6, 'X').slice(0, 6);
    }

    function getPlayerId() {
      const user = firebase.auth().currentUser;
      return user ? user.uid : `guest_${Date.now().toString().slice(-4)}`;
    }

    // ==========================
    // üéØ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('room');
      if (code) {
        document.getElementById('roomCode').value = code.toUpperCase();
        joinRoom(code.toUpperCase());
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      document.getElementById('createRoomBtn').addEventListener('click', createRoom);
      document.getElementById('joinRoomBtn').addEventListener('click', () => {
        const code = document.getElementById('roomCode').value.trim().toUpperCase();
        if (!code || code.length !== 6) {
          alert('‚ùå –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤');
          return;
        }
        joinRoom(code);
      });

      document.getElementById('backToMainBtn').addEventListener('click', () => {
        window.location.href = 'index.html';
      });

      // –î–∏–∞–ª–æ–≥ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
      document.getElementById('nameSubmitBtn').addEventListener('click', submitName);
      document.getElementById('nameCancelBtn').addEventListener('click', () => {
        document.getElementById('nameDialog').style.display = 'none';
        showScreen('roomScreen');
      });
      document.getElementById('playerNameInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') submitName();
      });

      // –õ–æ–±–±–∏: –∫–Ω–æ–ø–∫–∏
      document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
      document.getElementById('startGameBtn').addEventListener('click', startGame);
    });

    // ==========================
    // üöÄ –°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£
    // ==========================
    function createRoom() {
      roomId = generateRoomCode();
      playerId = getPlayerId();
      showScreen('loadingScreen');

      roomRef = firebase.database().ref(`rooms/${roomId}`);
      playersRef = roomRef.child('players');

      // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ —Å–ª—É—á–∞–π–Ω–æ
      roomRef.once('value', snap => {
        if (snap.exists()) {
          // –û—á–µ–Ω—å –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏–º
          createRoom();
          return;
        }

        // –°–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—É
        const now = Date.now();
        roomRef.set({
          createdAt: now,
          createdBy: playerId,
          status: 'lobby',
          players: {}
        }).then(() => {
          enterRoomAsCreator();
        }).catch(err => {
          alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É: ' + err.message);
          showScreen('roomScreen');
        });
      });
    }

    function enterRoomAsCreator() {
      document.getElementById('lobbyRoomCode').textContent = roomId;
      showScreen('nameDialog');
      document.getElementById('playerNameInput').value = '–•–æ–∑—è–∏–Ω';
      document.getElementById('playerNameInput').focus();
    }

    // ==========================
    // üîó –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –ö–û–ú–ù–ê–¢–ï
    // ==========================
    function joinRoom(code) {
      roomId = code.toUpperCase();
      playerId = getPlayerId();
      showScreen('loadingScreen');

      roomRef = firebase.database().ref(`rooms/${roomId}`);
      playersRef = roomRef.child('players');

      roomRef.once('value', snap => {
        if (!snap.exists()) {
          alert('‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞.');
          showScreen('roomScreen');
          return;
        }

        const roomData = snap.val();
        if (roomData.status !== 'lobby') {
          alert('‚ö†Ô∏è –ò–≥—Ä–∞ —É–∂–µ –∏–¥—ë—Ç. –î–æ–∂–¥–∏—Ç–µ—Å—å –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã.');
          showScreen('roomScreen');
          return;
        }

        document.getElementById('lobbyRoomCode').textContent = roomId;
        showScreen('nameDialog');
        document.getElementById('playerNameInput').focus();
      }).catch(err => {
        console.error(err);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
        showScreen('roomScreen');
      });
    }

    // ==========================
    // ‚úÖ –í–í–û–î –ò–ú–ï–ù–ò ‚Üí –í–•–û–î –í –õ–û–ë–ë–ò
    // ==========================
    function submitName() {
      const name = document.getElementById('playerNameInput').value.trim();
      if (!name || name.length < 2) {
        alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)');
        return;
      }

      playerName = name;
      document.getElementById('nameDialog').style.display = 'none';

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–º–Ω–∞—Ç—É
      playersRef.child(playerId).set({
        name: name,
        joinedAt: Date.now(),
        ready: false
      }).then(() => {
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
        attachPlayersListener();
        showScreen('lobbyScreen');
      }).catch(err => {
        console.error(err);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É');
        showScreen('roomScreen');
      });
    }

    // ==========================
    // üëÇ –°–õ–£–®–ê–¢–ï–õ–¨ –°–ü–ò–°–ö–ê –ò–ì–†–û–ö–û–í
    // ==========================
    function attachPlayersListener() {
      playersRef.on('value', snap => {
        const players = snap.val() || {};
        renderPlayers(players);
        updateStartButton(players);
      });
    }

    function renderPlayers(players) {
      const listEl = document.getElementById('playersList');
      const playersArray = Object.entries(players).map(([id, p]) => ({ id, ...p }));
      playersArray.sort((a, b) => a.joinedAt - b.joinedAt);

      if (playersArray.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#888;">–ü—É—Å—Ç–æ</p>';
        return;
      }

      listEl.innerHTML = playersArray.map(p => `
        <div class="player-item">
          <span class="player-name">${p.name}</span>
          <span class="player-ready">${p.ready ? '‚úÖ' : '‚è≥'}</span>
        </div>
      `).join('');
    }

    function updateStartButton(players) {
      const count = Object.keys(players).length;
      const readyCount = Object.values(players).filter(p => p.ready).length;
      const startBtn = document.getElementById('startGameBtn');

      if (count < 2) {
        startBtn.disabled = true;
        document.getElementById('readyStatus').textContent = `–û–∂–∏–¥–∞—é—Ç—Å—è –∏–≥—Ä–æ–∫–∏ (${count}/4)`;
        return;
      }

      // –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
      const isCreator = players[playerId]?.name && playerId === firebase.database().ref(`rooms/${roomId}`).child('createdBy').toString();
      // ‚Üë –Ω–æ –ø—Ä–æ—â–µ: –µ—Å–ª–∏ —Ç—ã –ø–µ—Ä–≤—ã–π –≤–æ—à—ë–ª ‚Äî —Å—á–∏—Ç–∞–π —Å–µ–±—è —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º
      // –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ: —Å—Ç–∞—Ä—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω, –µ—Å–ª–∏ ‚â•2 –∏–≥—Ä–æ–∫–∞ –∏ —Ç—ã ‚Äî –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
      // –†–µ–∞–ª–∏–∑—É–µ–º: —Å—Ç–∞—Ä—Ç ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ ‚â•2 –∏ –≤—Å–µ –≥–æ—Ç–æ–≤—ã, –ò–õ–ò ‚â•4 (–∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç)
      // –ü–æ–∫–∞ ‚Äî –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —É –≤—Å–µ—Ö, –Ω–æ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ 4 –∏–≥—Ä–æ–∫–∞

      const allReady = Object.values(players).every(p => p.ready);
      const full = count >= 4;

      if (full || (count >= 2 && allReady)) {
        startBtn.disabled = false;
        document.getElementById('readyStatus').textContent = full ? '‚úÖ –ì–æ—Ç–æ–≤—ã! –ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª' : '‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤—ã!';
      } else {
        startBtn.disabled = true;
        document.getElementById('readyStatus').textContent = `${count}/4 –∏–≥—Ä–æ–∫–æ–≤. –ì–æ—Ç–æ–≤–æ: ${readyCount}/${count}`;
      }
    }

    // ==========================
    // üö™ –í–´–•–û–î / –£–î–ê–õ–ï–ù–ò–ï
    // ==========================
    function leaveRoom() {
      if (playersRef && playerId) {
        playersRef.child(playerId).remove().catch(console.warn);
      }
      if (roomRef) {
        roomRef.child('players').off('value'); // –æ—Ç–ø–∏—Å–∫–∞
      }
      window.location.href = 'online.html';
    }

    // ==========================
    // ‚ñ∂Ô∏è –°–¢–ê–†–¢ –ò–ì–†–´
    // ==========================
    function startGame() {
      roomRef.once('value', snap => {
        const room = snap.val();
        if (!room || room.status !== 'lobby') return;

        const players = room.players || {};
        const playerNames = Object.values(players)
          .sort((a, b) => a.joinedAt - b.joinedAt)
          .map(p => p.name);

        if (playerNames.length < 2) {
          alert('‚ùó –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞');
          return;
        }

        // –î–æ–ø–æ–ª–Ω–∏–º –¥–æ 4 –∏–º—ë–Ω (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ‚Äî –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –≤–∞—à–∏–º –∫–æ–¥–æ–º
        while (playerNames.length < 4) {
          playerNames.push(`–ò–≥—Ä–æ–∫ ${playerNames.length + 1}`);
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ room.gameState
        const sessionName = `–ö–æ–º–Ω–∞—Ç–∞ ${roomId}`;
        const gameStateStub = {
          sessionName: sessionName,
          playerNames: playerNames.slice(0, 4),
          fants: [],
          votes: {},
          scores: {},
          revealed: {},
          availableEasy: [],
          availableHot: [],
          availableFire: [],
          currentPlayer: 0,
          currentFantIndex: 0
        };

        roomRef.update({
          status: 'names',
          gameState: gameStateStub
        }).then(() => {
          // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ–Ω–ª–∞–π–Ω-–≤–µ—Ä—Å–∏—é –≤–≤–æ–¥–∞ –∏–º—ë–Ω
          window.location.href = `online-names.html?room=${roomId}`;
        }).catch(err => {
          console.error(err);
          alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É');
        });
      });
    }
  </script>
</body>
</html>