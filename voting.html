<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(45deg, #6750A4, #FF5252);
      color: white;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }
    .screen {
      display: none;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    .active { display: block; }
    h1 { font-size: 2rem; margin-bottom: 1rem; text-align: center; }
    h2 { font-size: 1.6rem; margin: 1.2rem 0; text-align: center; }
    .fant-text {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 1.4rem;
      white-space: pre-wrap;
    }
    .counter { 
      background: #2a2a2a; 
      padding: 8px 16px; 
      border-radius: 8px; 
      margin: 16px 0; 
      display: inline-block; 
    }
    .votes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 24px 0;
    }
    button {
      font-size: 1.1rem;
      padding: 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .reject { background: #ba1a1a; }
    .easy { background: #4caf50; }
    .hot { background: #ff9800; }
    .fire { background: #f44336; }
    .player { 
      text-align: center; 
      font-size: 1.4rem; 
      margin: 16px 0;
      font-weight: bold;
    }
    #loading {
      text-align: center;
      font-size: 1.2rem;
      padding: 40px 0;
    }
  </style>
</head>
<body>
  <div id="loading" class="screen active">
    <h1>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</h1>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
  </div>

  <div id="playerTurn" class="screen">
    <h1>üéÆ –ù–æ–≤—ã–π —Ö–æ–¥</h1>
    <div class="player" id="turnPlayer">‚Äî</div>
    <button id="startTurnBtn" style="width:100%; max-width:300px;">–û–ö</button>
    <button id="backToMain" class="secondary" style="margin-top:12px; width:100%;">‚Üê –í –º–µ–Ω—é</button>
  </div>

  <div id="voting" class="screen">
    <div class="player" id="votingPlayer">‚Äî</div>
    <div class="counter">–û—Å—Ç–∞–ª–æ—Å—å —Ñ–∞–Ω—Ç–æ–≤: <span id="remainingCount">0</span></div>
    <div class="fant-text" id="currentFant">‚Äî</div>

    <div class="votes">
      <button class="reject" id="rejectBtn">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      <button class="easy" id="easyBtn">‚úÖ –õ–µ–≥–∫–æ (+1)</button>
      <button class="hot" id="hotBtn">üî• –ñ–∞—Ä–∫–æ (+2)</button>
      <button class="fire" id="fireBtn">üí• –û–≥–æ–Ω—å (+3)</button>
    </div>

    <button id="backToMain2" class="secondary" style="margin-top:12px; width:100%;">‚Üê –í –º–µ–Ω—é</button>
  </div>

  <div id="resultsRedirect" class="screen">
    <h1>üéâ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h1>
    <p>–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º...</p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- üîë Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOF1Vxk4FPoDd5imnm3TdjtsQDjC8qmdI",
      authDomain: "fants-game.firebaseapp.com",
      databaseURL: "https://fants-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fants-game",
      storageBucket: "fants-game.firebasestorage.app",
      messagingSenderId: "143359324758",
      appId: "1:143359324758:web:4c7b69c4d091ce712f41f7",
      measurementId: "G-TKHG5KNRZP"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
  <script src="script.js"></script>

  <script>
    let currentMode = 'solo'; // –∏–ª–∏ 'online'
    let currentRoomId = null;

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ, —Ç.–∫. script.js –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω)
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
      });
      const s = document.getElementById(id);
      if (s) {
        s.style.display = 'block';
        setTimeout(() => s.classList.add('active'), 10);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      showScreen('loading');

      const urlParams = new URLSearchParams(window.location.search);
      const sessionName = urlParams.get('session');
      const roomId = urlParams.get('room');

      if (!sessionName && !roomId) {
        alert('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω–∞ –∏–≥—Ä–∞');
        window.location.href = 'index.html';
        return;
      }

      // üîç –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º
      if (roomId) {
        currentMode = 'online';
        currentRoomId = roomId;
        console.log('üåê –†–µ–∂–∏–º: –æ–Ω–ª–∞–π–Ω-–∫–æ–º–Ω–∞—Ç–∞', roomId);
      } else {
        currentMode = 'solo';
        console.log('üßç –†–µ–∂–∏–º: —Å–æ–ª–æ, —Å–µ—Å—Å–∏—è:', sessionName);
      }

      // üîÅ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      const start = Date.now();
      const maxWait = 8000;

      function tryLoad() {
        let loaded = false;

        // üßç –°–æ–ª–æ: –∏–∑ localStorage
        if (currentMode === 'solo') {
          loaded = loadState(sessionName);
          if (loaded) {
            console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ localStorage');
            initVoting();
            return;
          }
        }

        // üåê –û–Ω–ª–∞–π–Ω: –∏–∑ Firebase
        if (currentMode === 'online') {
          loadGameStateFromRoom(roomId)
            .then(ok => {
              if (ok) {
                console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã');
                initVoting();
              } else {
                if (Date.now() - start < maxWait) {
                  setTimeout(tryLoad, 500);
                } else {
                  alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
                  window.location.href = 'index.html';
                }
              }
            })
            .catch(err => {
              console.error('Firebase room load error:', err);
              if (Date.now() - start < maxWait) {
                setTimeout(tryLoad, 500);
              } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ');
                window.location.href = 'index.html';
              }
            });
          return;
        }

        // –ñ–¥—ë–º Firebase-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–¥–ª—è —Å–æ–ª–æ-—Ä–µ–∂–∏–º–∞ —Å –æ–±–ª–∞–∫–æ–º)
        if (currentMode === 'solo' && typeof firebaseUser === 'undefined' && (Date.now() - start) < maxWait) {
          setTimeout(tryLoad, 400);
          return;
        }

        // –ü—Ä–æ–≤–∞–ª
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É');
        window.location.href = 'index.html';
      }

      tryLoad();

      // –ö–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥"
      document.getElementById('backToMain')?.addEventListener('click', () => window.location.href = 'index.html');
      document.getElementById('backToMain2')?.addEventListener('click', () => window.location.href = 'index.html');
    });

    function initVoting() {
      // üîÅ –ü—Ä–æ–≤–µ—Ä–∫–∞
      if (!gameState || !gameState.sessionName || !gameState.playerNames?.length) {
        alert('‚ùå –î–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã');
        window.location.href = 'index.html';
        return;
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      if (!gameState.scores) gameState.scores = {};
      if (!gameState.revealed) gameState.revealed = {};
      if (!gameState.votes || typeof gameState.votes !== 'object') gameState.votes = {};

      // ‚úÖ –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Ñ–∞–Ω—Ç—ã (–∫–∞–∫ –≤ Android)
      for (let i = gameState.fants.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [gameState.fants[i], gameState.fants[j]] = [gameState.fants[j], gameState.fants[i]];
      }

      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–Ω—Ç–∞ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ –≥–æ–ª–æ—Å–æ–≤
      for (const fant of gameState.fants) {
        if (!gameState.votes[fant] || !Array.isArray(gameState.votes[fant])) {
          gameState.votes[fant] = [0, 0, 0, 0]; // 4 –∏–≥—Ä–æ–∫–∞
        }
      }

      let currentPlayer = gameState.currentPlayer || 0;
      let currentFantIndex = gameState.currentFantIndex || 0;

      function showPlayerTurn() {
        document.getElementById('turnPlayer').textContent = 
          gameState.playerNames[currentPlayer] || `–ò–≥—Ä–æ–∫ ${currentPlayer + 1}`;
        showScreen('playerTurn');
      }

      function updateVotingUI() {
        if (currentFantIndex >= gameState.fants.length) {
          currentPlayer++;
          if (currentPlayer < 4) {
            currentFantIndex = 0;
            gameState.currentPlayer = currentPlayer;
            gameState.currentFantIndex = currentFantIndex;
            saveState();
            showPlayerTurn();
          } else {
            finishVoting();
          }
          return;
        }

        const currentFant = gameState.fants[currentFantIndex];
        const remaining = gameState.fants.length - currentFantIndex;

        document.getElementById('votingPlayer').textContent = 
          gameState.playerNames[currentPlayer] || `–ò–≥—Ä–æ–∫ ${currentPlayer + 1}`;
        document.getElementById('remainingCount').textContent = remaining;
        document.getElementById('currentFant').textContent = currentFant;

        showScreen('voting');
      }

      function vote(score) {
        const currentFant = gameState.fants[currentFantIndex];
        gameState.votes[currentFant][currentPlayer] = score;
        currentFantIndex++;
        gameState.currentFantIndex = currentFantIndex;
        saveState();
        updateVotingUI();
      }

      function finishVoting() {
        const scores = {};
        const revealed = {};
        const finalFants = [];

        for (const fant of gameState.fants) {
          const votes = gameState.votes[fant];
          const rejected = votes.includes(-1);
          if (!rejected) {
            const total = votes.reduce((a, b) => a + (b > 0 ? b : 0), 0);
            scores[fant] = total;
            revealed[fant] = false;
            finalFants.push(fant);
          }
        }

        gameState.scores = scores;
        gameState.revealed = revealed;
        gameState.fants = finalFants;
        gameState.status = 'completed';

        saveState();

        showScreen('resultsRedirect');
        setTimeout(() => {
          if (currentMode === 'online') {
            window.location.href = `results.html?room=${currentRoomId}`;
          } else {
            window.location.href = `results.html?session=${encodeURIComponent(gameState.sessionName)}`;
          }
        }, 1000);
      }

      // üîπ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      document.getElementById('startTurnBtn')?.addEventListener('click', updateVotingUI);
      document.getElementById('rejectBtn')?.addEventListener('click', () => vote(-1));
      document.getElementById('easyBtn')?.addEventListener('click', () => vote(1));
      document.getElementById('hotBtn')?.addEventListener('click', () => vote(2));
      document.getElementById('fireBtn')?.addEventListener('click', () => vote(3));

      // ‚úÖ –°—Ç–∞—Ä—Ç
      showPlayerTurn();
    }
  </script>
</body>
</html>