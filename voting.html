<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(45deg, #6750A4, #FF5252);
      color: white;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }
    .screen {
      display: none;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    .active { display: block; }
    h1 { font-size: 2rem; margin-bottom: 1rem; text-align: center; }
    h2 { font-size: 1.6rem; margin: 1.2rem 0; text-align: center; }
    .fant-text {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 1.4rem;
      white-space: pre-wrap;
    }
    .counter { 
      background: #2a2a2a; 
      padding: 8px 16px; 
      border-radius: 8px; 
      margin: 16px 0; 
      display: inline-block; 
    }
    .votes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 24px 0;
    }
    button {
      font-size: 1.1rem;
      padding: 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .reject { background: #ba1a1a; }
    .easy { background: #4caf50; }
    .hot { background: #ff9800; }
    .fire { background: #f44336; }
    .player { 
      text-align: center; 
      font-size: 1.4rem; 
      margin: 16px 0;
      font-weight: bold;
    }
    #loading {
      text-align: center;
      font-size: 1.2rem;
      padding: 40px 0;
    }
  </style>
</head>
<body>
  <div id="loading" class="screen active">
    <h1>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</h1>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
  </div>

  <div id="playerTurn" class="screen">
    <h1>üéÆ –ù–æ–≤—ã–π —Ö–æ–¥</h1>
    <div class="player" id="turnPlayer">‚Äî</div>
    <button id="startTurnBtn" style="width:100%; max-width:300px;">–û–ö</button>
  </div>

  <div id="voting" class="screen">
    <div class="player" id="votingPlayer">‚Äî</div>
    <div class="counter">–û—Å—Ç–∞–ª–æ—Å—å —Ñ–∞–Ω—Ç–æ–≤: <span id="remainingCount">0</span></div>
    <div class="fant-text" id="currentFant">‚Äî</div>

    <div class="votes">
      <button class="reject" id="rejectBtn">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      <button class="easy" id="easyBtn">‚úÖ –õ–µ–≥–∫–æ (+1)</button>
      <button class="hot" id="hotBtn">üî• –ñ–∞—Ä–∫–æ (+2)</button>
      <button class="fire" id="fireBtn">üí• –û–≥–æ–Ω—å (+3)</button>
    </div>
  </div>

  <div id="resultsRedirect" class="screen">
    <h1>üéâ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h1>
    <p>–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º...</p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- üîë Firebase Config & Init -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOF1Vxk4FPoDd5imnm3TdjtsQDjC8qmdI",
      authDomain: "fants-game.firebaseapp.com",
      databaseURL: "https://fants-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fants-game",
      storageBucket: "fants-game.firebasestorage.app",
      messagingSenderId: "143359324758",
      appId: "1:143359324758:web:4c7b69c4d091ce712f41f7",
      measurementId: "G-TKHG5KNRZP"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
  <script src="script.js"></script>

  <script>
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–ï –î–£–ë–õ–ò–†–£–ô–¢–ï script.js! –û–Ω —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –≤—ã—à–µ.
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionName = urlParams.get('session');

      if (!sessionName) {
        alert('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω–∞ –∏–≥—Ä–∞');
        window.location.href = 'index.html';
        return;
      }

      showScreen('loading');

      const maxWait = 8000;
      const start = Date.now();

      function tryLoad() {
        if (loadState(sessionName)) {
          console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ localStorage');
          initVoting();
          return true;
        }

        if (typeof firebaseUser !== 'undefined' && (Date.now() - start) < maxWait) {
          setTimeout(tryLoad, 400);
          return true;
        }

        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
        window.location.href = 'index.html';
        return false;
      }

      tryLoad();
    });

    function initVoting() {
  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –∏–≥—Ä–∞?
  if (!gameState || !gameState.sessionName) {
    console.error("‚ùå gameState –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É.');
    window.location.href = 'index.html';
    return;
  }

  // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
  if (!gameState.scores) gameState.scores = {};
  if (!gameState.revealed) gameState.revealed = {};

  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Ñ–∞–Ω—Ç—ã?
  if (!gameState.fants || gameState.fants.length === 0) {
    alert('‚ùå –ù–µ—Ç —Ñ–∞–Ω—Ç–æ–≤ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω.');
    window.location.href = 'index.html';
    return;
  }

  // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ gameState, –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
for (let i = 0; i < gameState.fants.length; i++) {
  let fant = gameState.fants[i];
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—É—Ñ—Ñ–∏–∫—Å: –º–æ–∂–Ω–æ –∏ –±–µ–∑ Date.now()
  const suffix = Math.random().toString(36).slice(2, 8); // –Ω–∞–ø—Ä–∏–º–µ—Ä: "a3f9xk"

  if (typeof fant === 'string') {
    gameState.fants[i] = {
      id: `fant_${i}_${suffix}`,
      text: fant
    };
  } else if (!fant.id) {
    gameState.fants[i] = {
      ...fant,
      id: `fant_obj_${i}_${suffix}`
    };
  }
}

  // üîÄ –ü–ï–†–ï–ú–ï–®–ò–í–ê–ù–ò–ï –§–ê–ù–¢–û–í ‚Äî –∫–∞–∫ –≤ Android (Fisher-Yates shuffle)
  for (let i = gameState.fants.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [gameState.fants[i], gameState.fants[j]] = [gameState.fants[j], gameState.fants[i]];
  }

  // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
  if (!gameState.votes || typeof gameState.votes !== 'object') {
    gameState.votes = {};
  }
  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–Ω—Ç–∞ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ –≥–æ–ª–æ—Å–æ–≤
  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–Ω—Ç–∞ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ –≥–æ–ª–æ—Å–æ–≤
for (const fant of gameState.fants) {
  if (
    !gameState.votes[fant.id] ||
    !Array.isArray(gameState.votes[fant.id])
  ) {
    gameState.votes[fant.id] = [0, 0, 0, 0]; // 4 –∏–≥—Ä–æ–∫–∞
  }
}


  let currentPlayer = gameState.currentPlayer || 0;
  let currentFantIndex = gameState.currentFantIndex || 0;

  function showPlayerTurn() {
    document.getElementById('turnPlayer').textContent = 
      gameState.playerNames[currentPlayer] || `–ò–≥—Ä–æ–∫ ${currentPlayer + 1}`;
    showScreen('playerTurn');
  }

  function updateVotingUI() {
    if (currentFantIndex >= gameState.fants.length) {
      currentPlayer++;
      if (currentPlayer < 4) {
        currentFantIndex = 0;
        gameState.currentPlayer = currentPlayer;
        gameState.currentFantIndex = currentFantIndex;
        saveState();
        showPlayerTurn();
      } else {
        finishVoting();
      }
      return;
    }

    const currentFant = gameState.fants[currentFantIndex];
    const remaining = gameState.fants.length - currentFantIndex;

    document.getElementById('votingPlayer').textContent = 
      gameState.playerNames[currentPlayer] || `–ò–≥—Ä–æ–∫ ${currentPlayer + 1}`;
    document.getElementById('remainingCount').textContent = remaining;
    document.getElementById('currentFant').textContent =
  typeof currentFant === 'string'
    ? currentFant
    : currentFant.text;


    showScreen('voting');
  }

  function vote(score) {
    const currentFant = gameState.fants[currentFantIndex];
    gameState.votes[currentFant.id][currentPlayer] = score;
    currentFantIndex++;
    gameState.currentFantIndex = currentFantIndex;
    saveState();
    updateVotingUI();
  }

  function finishVoting() {
    const scores = {};
    const revealed = {};
    const finalFants = [];

    for (const fant of gameState.fants) {
  const votes = gameState.votes[fant.id];
  const rejected = votes.includes(-1);

  if (!rejected) {
    const total = votes.reduce((a, b) => a + (b > 0 ? b : 0), 0);
    scores[fant.id] = total;
    revealed[fant.id] = false;
    finalFants.push(fant);
  }
}


    gameState.scores = scores;
    gameState.revealed = revealed;
    gameState.fants = finalFants;
    gameState.status = 'completed';

    saveState();

    showScreen('resultsRedirect');
    setTimeout(() => {
      window.location.href = `results.html?session=${encodeURIComponent(gameState.sessionName)}`;
    }, 1000);
  }

  // üîπ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  document.getElementById('startTurnBtn')?.addEventListener('click', updateVotingUI);
  document.getElementById('rejectBtn')?.addEventListener('click', () => vote(-1));
  document.getElementById('easyBtn')?.addEventListener('click', () => vote(1));
  document.getElementById('hotBtn')?.addEventListener('click', () => vote(2));
  document.getElementById('fireBtn')?.addEventListener('click', () => vote(3));

  // ‚úÖ –°—Ç–∞—Ä—Ç
  showPlayerTurn();
}
  </script>
</body>
</html>