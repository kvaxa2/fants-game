<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(45deg, #6750A4, #FF5252);
      color: white;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }
    .screen {
      display: none;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    .active { display: block; }
    h1 { font-size: 2.2rem; margin-bottom: 1rem; text-align: center; }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .tab-btn {
      flex: 1;
      min-width: 100px;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: #333;
      color: #fff;
      font-weight: 600;
    }
    .tab-btn.active {
      background: #6750A4;
    }
    .fants-list {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 12px;
      margin: 16px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    .fant-item {
      background: #2d2d2d;
      padding: 14px;
      margin: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
    }
    .fant-item.revealed { color: #fff; }
    .fant-item.hidden { color: #888; }
    .save-btn {
      width: 100%;
      padding: 14px;
      margin-top: 20px;
      background: #6750A4;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1.1rem;
      font-weight: bold;
    }
    #loading {
      text-align: center;
      font-size: 1.2rem;
      padding: 40px 0;
    }
    .secondary {
      background: #333 !important;
    }
  </style>
</head>
<body>
  <div id="loading" class="screen active">
    <h1>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</h1>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
  </div>

  <div id="resultsScreen" class="screen">
    <h1>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</h1>

    <div class="tabs">
      <button class="tab-btn active" data-tab="easy">‚úÖ –õ—ë–≥–∫–æ (1‚Äì6)</button>
      <button class="tab-btn" data-tab="hot">üî• –ñ–∞—Ä–∫–æ (7‚Äì9)</button>
      <button class="tab-btn" data-tab="fire">üí• –û–≥–æ–Ω—å (10+)</button>
    </div>

    <div id="fantListContainer" class="fants-list"></div>

    <button class="save-btn" id="saveResultsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É</button>
    <button class="secondary" id="backToMain" style="margin-top:12px; width:100%;">‚Üê –í –º–µ–Ω—é</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- üîë Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOF1Vxk4FPoDd5imnm3TdjtsQDjC8qmdI",
      authDomain: "fants-game.firebaseapp.com",
      databaseURL: "https://fants-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fants-game",
      storageBucket: "fants-game.firebasestorage.app",
      messagingSenderId: "143359324758",
      appId: "1:143359324758:web:4c7b69c4d091ce712f41f7",
      measurementId: "G-TKHG5KNRZP"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
  <script src="script.js"></script>

  <!-- –î–∏–∞–ª–æ–≥–∏ -->
  <dialog id="fantActionDialog">
    <h3 id="dialogTitle">‚ùì –§–∞–Ω—Ç</h3>
    <p id="dialogFantText" style="font-size:1.2rem; margin:16px 0; word-break:break-word;"></p>
    <div style="display:flex; gap:10px;">
      <button id="dialogRevealBtn" style="flex:1; padding:12px; background:#4caf50; border:none; border-radius:8px; color:white; font-weight:bold;">–û–ö</button>
      <button id="dialogDeleteBtn" style="flex:1; padding:12px; background:#ba1a1a; border:none; border-radius:8px; color:white; font-weight:bold;">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </dialog>

  <dialog id="confirmDeleteDialog">
    <h3 style="color:#ff9800;">‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å —Ñ–∞–Ω—Ç?</h3>
    <p id="confirmFantText" style="margin:16px 0;"></p>
    <div style="display:flex; gap:10px;">
      <button id="confirmNoBtn" style="flex:1; padding:12px; background:#333; border:none; border-radius:8px; color:white;">–ù–µ—Ç</button>
      <button id="confirmYesBtn" style="flex:1; padding:12px; background:#ba1a1a; border:none; border-radius:8px; color:white; font-weight:bold;">–î–∞</button>
    </div>
  </dialog>

  <script>
    let currentMode = 'solo';
    let currentRoomId = null;

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
      });
      const s = document.getElementById(id);
      if (s) {
        s.style.display = 'block';
        setTimeout(() => s.classList.add('active'), 10);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      showScreen('loading');

      const urlParams = new URLSearchParams(window.location.search);
      const sessionName = urlParams.get('session');
      const roomId = urlParams.get('room');

      if (!sessionName && !roomId) {
        alert('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω–∞ –∏–≥—Ä–∞');
        window.location.href = 'index.html';
        return;
      }

      currentMode = roomId ? 'online' : 'solo';
      currentRoomId = roomId;

      const start = Date.now();
      const maxWait = 8000;

      function tryLoad() {
        let loaded = false;

        if (currentMode === 'solo') {
          loaded = loadState(sessionName);
        } else if (currentMode === 'online') {
          loadGameStateFromRoom(roomId)
            .then(ok => {
              if (ok) {
                initResults();
              } else if (Date.now() - start < maxWait) {
                setTimeout(tryLoad, 400);
              } else {
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã');
                window.location.href = 'index.html';
              }
            })
            .catch(err => {
              console.error(err);
              if (Date.now() - start < maxWait) {
                setTimeout(tryLoad, 400);
              } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                window.location.href = 'index.html';
              }
            });
          return;
        }

        if (loaded) {
          initResults();
        } else if ((Date.now() - start) < maxWait) {
          setTimeout(tryLoad, 400);
        } else {
          alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É');
          window.location.href = 'index.html';
        }
      }

      tryLoad();

      document.getElementById('backToMain')?.addEventListener('click', () => {
        window.location.href = 'index.html';
      });
    });

    function initResults() {
      if (!gameState || !gameState.sessionName) {
        alert('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        window.location.href = 'index.html';
        return;
      }

      // üîß –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∫–ª—é—á–µ–π Firebase
      if (gameState.scores && typeof gameState.scores === 'object') {
        const newScores = {};
        for (let key in gameState.scores) newScores[String(key)] = gameState.scores[key];
        gameState.scores = newScores;
      } else gameState.scores = {};

      if (gameState.revealed && typeof gameState.revealed === 'object') {
        const newRevealed = {};
        for (let key in gameState.revealed) newRevealed[String(key)] = gameState.revealed[key];
        gameState.revealed = newRevealed;
      } else gameState.revealed = {};

      if (!Array.isArray(gameState.fants)) gameState.fants = [];

      function showCategory(tab, min, max) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });

        const list = document.getElementById('fantListContainer');
        const filtered = gameState.fants
          .filter(fant => {
            const score = gameState.scores[String(fant)] || 0;
            return score >= min && score <= max;
          })
          .sort(() => Math.random() - 0.5);

        if (filtered.length === 0) {
          list.innerHTML = `<p style="text-align:center;color:#888;">–ù–µ—Ç —Ñ–∞–Ω—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´${tab}¬ª</p>`;
        } else {
          list.innerHTML = filtered.map(fant => 
            `<div class="fant-item ${gameState.revealed[String(fant)] ? 'revealed' : 'hidden'}" data-fant="${String(fant)}">
              ${gameState.revealed[String(fant)] ? String(fant) : '******'}
            </div>`
          ).join('');

          list.querySelectorAll('.fant-item').forEach(item => {
            item.addEventListener('click', () => {
              const fant = item.dataset.fant;
              if (gameState.revealed[fant]) {
                alert(fant);
                return;
              }

              const dialog = document.getElementById('fantActionDialog');
              document.getElementById('dialogFantText').textContent = fant;

              document.getElementById('dialogRevealBtn').onclick = () => {
                gameState.revealed[fant] = true;
                saveState();
                showCategory(tab, min, max);
                dialog.close();
              };

              document.getElementById('dialogDeleteBtn').onclick = () => {
                dialog.close();
                const confirmDialog = document.getElementById('confirmDeleteDialog');
                document.getElementById('confirmFantText').textContent = `¬´${fant}¬ª –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –Ω–∞–≤—Å–µ–≥–¥–∞.`;

                document.getElementById('confirmNoBtn').onclick = () => confirmDialog.close();
                document.getElementById('confirmYesBtn').onclick = () => {
                  gameState.fants = gameState.fants.filter(f => String(f) !== fant);
                  delete gameState.scores[fant];
                  delete gameState.revealed[fant];
                  saveState();
                  showCategory(tab, min, max);
                  confirmDialog.close();
                };
                confirmDialog.showModal();
              };

              dialog.showModal();
            });
          });
        }
      }

      // üîπ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      document.querySelector('[data-tab="easy"]')?.addEventListener('click', () => showCategory('easy', 1, 6));
      document.querySelector('[data-tab="hot"]')?.addEventListener('click', () => showCategory('hot', 7, 9));
      document.querySelector('[data-tab="fire"]')?.addEventListener('click', () => showCategory('fire', 10, 999));

      document.getElementById('saveResultsBtn')?.addEventListener('click', () => {
        if (currentMode === 'online') {
          alert('‚úÖ –ò–≥—Ä–∞ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –æ–±–ª–∞–∫–æ');
          return;
        }

        const name = prompt('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥ –∏–º–µ–Ω–µ–º:', gameState.sessionName) || gameState.sessionName;
        if (!name) return;

        gameState.sessionName = name;
        saveState();

        const names = JSON.parse(localStorage.getItem('saved_games') || '[]');
        if (!names.includes(name)) {
          names.push(name);
          localStorage.setItem('saved_games', JSON.stringify(names));
        }

        alert(`‚úÖ –ò–≥—Ä–∞ ¬´${name}¬ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
      });

      // –ü–æ–∫–∞–∑
      setTimeout(() => {
        showScreen('resultsScreen');
        showCategory('easy', 1, 6);
      }, 200);
    }
  </script>
</body>
</html>